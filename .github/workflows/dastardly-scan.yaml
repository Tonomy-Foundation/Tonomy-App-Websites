name: Dastardly Scan Action

on:
  push:
    branches:
      - feature/149-dastardly-actions
      - development
      - master

jobs:
  dastardly-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Enable Debug Mode
        run: echo "::set-env name=ACTIONS_STEP_DEBUG::true"

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -t dastardly-image .

      - name: ðŸš€ Build and publish tonomy app
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
      - run: corepack enable
      - run: node src/generate-sitemap.js
      - run: yarn install
      - run: yarn run build
      - run: echo "${PWD}"
      - run: yarn run start:prod &
      - run: sleep 10
      - run: ls 
      - run: cat "${PWD}/build.txt"
      - run: curl http://accounts.localhost:5147

      # - name: Set Target URL
      #   id: set-target-url
      #   run: |
      #     target_url="http://accounts.localhost:5147"
        # run: |
        #   if [[ ${GITHUB_REF#refs/*/} == "development" ]]; then
        #     node src/generate-sitemap.js staging
        #     target_url="https://demo.staging.tonomy.foundation/sitemap.xml"
        #   elif [[ ${GITHUB_REF#refs/*/} == "master" ]]; then
        #     node src/generate-sitemap.js demo
        #     target_url="https://demo.demo.tonomy.foundation/sitemap.xml"
        #   else
        #     node src/generate-sitemap.js
        #     target_url="http://demo.localhost:5147"
        #   fi
        #   echo "$target_url"
    
      # - name: Run Dastardly Scan and Capture Output
      #   # uses: PortSwigger/dastardly-github-action@main
      #   # with:
      #   #   target-url: 'http://accounts.localhost:5147'
      #   #   output-filename: '${PWD}/dastardly-report.xml'        
      #   run: |
      #     # Iterate through each URL and run Dastardly scan
      #     while IFS= read -r url; do
      #       docker run --rm \
      #         -e DASTARDLY_TARGET_URL="http://accounts.localhost:5147" \
      #         -e DASTARDLY_OUTPUT_FILE="${PWD}/dastardly-report.xml" \
      #         >> scan-output.xml 2>&1
      #     done < urls.txt

      # - name: Upload Scan Output
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: dastardly-scan-output
      #     path: dastardly-report.xml

name: Dastardly Scan Action

on:
  push:
    branches:
      - feature/149-dastardly-actions
      - development
      - master

jobs:
  dastardly-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build Docker Image
        run: docker build -t dastardly-image .

      - name: Set Target URL
        id: set-target-url
        run: |
          node src/generate-sitemap.js
          target_url="http://demo.localhost:5147"
        # run: |
        #   if [[ ${GITHUB_REF#refs/*/} == "development" ]]; then
        #     node src/generate-sitemap.js staging
        #     target_url="https://demo.staging.tonomy.foundation/sitemap.xml"
        #   elif [[ ${GITHUB_REF#refs/*/} == "master" ]]; then
        #     node src/generate-sitemap.js demo
        #     target_url="https://demo.demo.tonomy.foundation/sitemap.xml"
        #   else
        #     node src/generate-sitemap.js
        #     target_url="http://demo.localhost:5147"
        #   fi
        #   echo "$target_url"
    
      - name: Run Dastardly Scan and Capture Output
        uses: PortSwigger/dastardly-github-action@main
        with:
          target-url: 'https://accounts.staging.tonomy.foundation'
          output-filename: 'dastardly-report.xml'
        # run: |
        #   # Iterate through each URL and run Dastardly scan
        #   while IFS= read -r url; do
        #     docker run --rm \
        #       -e DASTARDLY_TARGET_URL="$url" \
        #       -e DASTARDLY_OUTPUT_FILE="/dastardly-report.xml" \
        #       -v ${{ github.workspace }}:/github/workspace dastardly-image \
        #       >> scan-output.xml 2>&1
        #   done < urls.txt

      - name: Upload Scan Output
        uses: actions/upload-artifact@v3
        with:
          name: dastardly-scan-output
          path: dastardly-report.xml
